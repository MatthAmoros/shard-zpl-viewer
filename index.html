<!--
    @author : Matthieu AMOROS
    @description : ZPL interpreter
-->

<textarea id="label" placeholder="ZPL Label" rows="20" cols="75">
</textarea>
<br />
<input type="button" onclick="displayLabel('myCanvas', $('#label').val());" value="preview" />
<br />
<canvas id='myCanvas' height="2000" width="1000"></canvas>

<script src="http://code.jquery.com/jquery-latest.min.js"></script>
<script type="text/javascript" src="jquery-barcode.js"></script>
<script>
	function getPositionFromCommand(command) {
		const regex = /((\^FT)|(\^FO))(.[0-9,]*)\^/;
		let results = regex.exec(command);
		//Second result is position
		if(results != null && results.length >= 2)		
			return results[results.length - 1].split(',');
		else
			//Not found
			return "NA,NA".split(',');
	}
	
	function getTextValueFromCommand(command) {
		const regex = /\^FD(.*)\^FS/u;
		let results = regex.exec(command);
		//Second result is position
		if(results != null)		
			return results[1];
		else
			//Not found
			return "";
	}

    /**
    * [displayLabel: Display label represented by ZPL code on target canvas]
    * @param  {[string]} canvasId [canvas element id]
    * @param  {[string]} label [ZPL code]
    */
    function displayLabel(canvasId, label) {
        //Canvas context
        var c = document.getElementById(canvasId);
        var ctx = c.getContext("2d");
		
        //Clear
		ctx.restore();
        ctx.clearRect(0, 0, c.width, c.height);
        ctx.save();

		let currentPosition = "0,0".split(',');
		
        //Get each command
        var commandLines = label.match(/\^(.*)\^FS/mg);
        try {
            if (commandLines.length > 0) {
                commandLines.forEach(function (commandLine) {
                    let formatedText = commandLine;
                    let properties = formatedText.split('^');
					let rads = 0;
					let position = "0,0".split(',');

                    //Get position
					let newPosition = getPositionFromCommand(commandLine);
					if(isNaN(newPosition[0]) || isNaN(newPosition[1]))
					{
						console.log("No position found, keep current one.");
						position = currentPosition;
					}
					else
					{
						currentPosition = newPosition;
						position = currentPosition;
					}
					
					let x, y = 0;
					x = parseInt(position[0]);
					y = parseInt(position[1]);
                    
					//Get text value
                    let textValue = getTextValueFromCommand(commandLine);		
					
                    //FX = Comment, continue
                    if (formatedText.indexOf('^FX') >= 0 || isNaN(position[0]) || isNaN(position[1])) { 
						console.log("Not displayed : " + formatedText.replace('^FX', '')); return; 
					}

                    if (containsBarCodeDefinition(commandLine)) {					
						//Rotate
						rads = getRotationFromCode(properties[3]);
						
						if (rads > 0) {
							//Translate to object position to apply rotation
							ctx.translate(x , y);
							ctx.rotate(rads);
							//Already on point, relative coordinate are 0
							x = 0;
							y = 0;
						}

                        $("#" + canvasId).barcode(
                            textValue,
                            getBarcodeTypeFromCode(commandLine),
							//getBarcodeParameters(commandLine), //Switch according to barcode type
                            { output: 'canvas', posX: x, posY: y, showHRI: true }
                        );
						console.log("[" + x + "," + y + ":" + rads + "|BARCODE " + getBarcodeTypeFromCode(commandLine) +"] " + textValue);
                        
                    }					
                    else if (properties[2].startsWith("GB")) {
                        //Box
                        drawBox(position, properties[2].replace('GB', ''), ctx);
                    }					
                    else {
                        //Text & font
                        ctx.font = getFontFromCode(properties[2]);

                        //Rotate
                        rads = getRotationFromCode(properties[2]);

						if (rads > 0) {
							//Translate to object position to apply rotation
							ctx.translate(x , y);
							ctx.rotate(rads);
							//Already on point, relative coordinate are 0
							x = 0;
							y = 0;
						}
						
                        ctx.fillText(textValue, x, y);
                        console.log("[" + x + "," + y + ":" + rads + "|" + ctx.font + "] " + textValue);
                    }

					//Reset transform
					ctx.resetTransform();
                });
            }
        }
        catch (error) {
            console.error(error);
        }
		finally {
			ctx.restore();
		}
    }
	
	function containsBarCodeDefinition(commandLine) {
		//Should match ^BCo,h,f,g,e,m
		const regex = /\^B.([A0-Z9,]{6,})\^/;
		let results = regex.exec(commandLine);
		return (results != null);
	}
	
	function getBarcodeParameters(commandLine) {
		//Should match ^B.o,h,f,g,e,m
		const regex = /\^B.([A0-Z9,]{6,})\^/;
		let results = regex.exec(commandLine);
		//Second result is position
		if(results != null){
			let barcodeParameters = results[1].split(',');
			if(barcodeParameters.length == 5) {
				let orientation = barcodeParameters[0];
				let barCodeHeight = barcodeParameters[1];
				let printInterpretationLine = barcodeParameters[2];
				let printInterpretationLineAboveCode = barcodeParameters[3];
				let uccCheckDigit = barcodeParameters[4];
				return {barHeight: parseInt(barCodeHeight)};
			}
			else
				return {};
			
		}
		else
			//Not found
			return {};
	}

    function getRotationFromCode(property) {
        //"A@N,23,22,TT0003M_"
        let angle;
        switch (property[2]) {
            case "N":
                angle = 0;
                break;
            case "R":
                angle = 90;
                break;
            case "I":
                angle = 180;
                break;
            case "B":
                angle = 270;
                break;
            default:
                angle = 0;
                break;
        }
        return (Math.PI / 180) * angle;
    }

    /**
    * [drawBox: Draw box according to ZPL parameters]
    * @param  {[string]} position [position string]
    * @param  {[string]} parameters [parameters string, separated with coma]
    * @param  {[object]} ctx [canvas context]
    */
    function drawBox(position, parameters, ctx) {
        //parameter = 0,347,7
        //Default values
        var width, height, thickness = 1;
        var color = 'B';
        var cornerRounding = 0;
        var x, y = 0;

        var splitted = parameters.split(',');

        for (var i in splitted) {
            switch (i) {
                case '0':
                    width = parseInt(splitted[i]);
                    break;

                case '1':
                    height = parseInt(splitted[i]);
                    break;

                case '2':
                    thickness = parseInt(splitted[i]);
                    break;

                case '3':
                    color = splitted[i];
                    break;

                case '4':
                    cornerRounding = parseInt(splitted[i]);
                    break;

                default:
                    break;
            }
        }

        x = parseInt(position[0]);
        y = parseInt(position[1]);
        ctx.lineWidth = thickness;
        ctx.strokeStyle = "black";
        ctx.rect(x, y, width, height);
        ctx.stroke();
    }

    /**
    * [getBarcodeTypeFromCode: Get barcode type from ZPL code]
    * @param  {[string]} code [ZPL code]
    * @return {[string]} [barcode type]
    */
    function getBarcodeTypeFromCode(commandLine) {
		const regex = /\^B([^Y])/;
		let results = regex.exec(commandLine);
		if(results != null) {		
	        switch (results[1]) {
	            case 'A':
	                return 'code93';
	                break;
	            case 'B':
	            case 'R':
				case 'C':
	                return 'code128';
	                break;
	            case '1':
	                return 'code11';
	                break;
	            case '2':
	                return 'int25';
	                break;
	            case '3':
	                return 'code39';
	                break;
	            case '4':
	                return 'code49';
	                break;
	            case '8':
	                return 'ean8';
	                break;
	            case '9':
	            case '5':
	            case '6':
	            case '7':
	                return 'code128';
	                break;
				case 'Y':
					//Not a barcode
					return '';
					break;
					
				case 'X':
					//Not a barcode
					return 'datamatrix';
					break;
	
	            default:
	                return 'code128';
	                break;
	        }
		}
		else
			return '';
    }

    /**
    * [getFontFromCode: Get font type from ZPL code]
    * @param  {[string]} code [ZPL code]
    * @return {[string]} [font type]
    */
    function getFontFromCode(code) {
        let fontName = 'Courrier Sans MS'
        let fontSize = 'px'

        properties = code.split(',');
        let fontCode = properties[0].substring(0, 2);

        switch (fontCode) {
            case 'A0':
                fontName = 'Courrier Sans MS'
                break;

            default:
                break;
        }
			
		if (parseInt(properties[1]) <= 60)
        	fontSize = properties[1] + fontSize;
		else
			//Limit
			fontSize = '24px';

        return fontSize + ' ' + fontName;
    }

    /**
    * [getTextValueFronProperties: Get text value from ZPL properties]
    * @param  {[string]} properties [ZPL code]
    * @return {[string]} [text value]
    */
    function getTextValueFronProperties(properties) {
        var textValue = ""
        properties.forEach(function (property) {
            if (property.indexOf('FD') >= 0) {
                textValue = property.replace('FD', '');
            }
        });

        return textValue;
    }

</script>